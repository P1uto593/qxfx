<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>提交文档</title>

  <link rel="stylesheet" href="resource/plugins/elementui/index.css">
  <link rel="stylesheet"
        href="resource/plugins/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="resource/css/style.css">
  <link rel="stylesheet" href="resource/css/mystyle.css">
  <script type="text/javascript" src="resource/js/jquery.min.js"></script>
  <script src="resource/js/vue.js"></script>
  <script src="resource/plugins/elementui/index.js"></script>
  <script src="resource/js/axios-0.18.0.js"></script>
</head>
<body class="hold-transition">
<div id="app">
  <div style="width: 90%;margin-left: 5%">
    <h1>软件缺陷分析系统</h1>
  </div>
  <div class="app-container">
    <el-tabs v-model="activeName" style="width: 94%;margin-left: 3%">
      <el-tab-pane label="数据集" name="first">
        <div>
          <el-table
                  :data="dataSetTable"
                  v-loading="dataSetloading"
                  stripe
                  style="width: 100%">
            <el-table-column
                    prop="name"
                    label="数据集名称"
                    min-width="50%">
            </el-table-column>
            <el-table-column
                    prop="type"
                    label="数据集类型"
                    min-width="50%">
            </el-table-column>
          </el-table>
        </div>
      </el-tab-pane>
      <el-tab-pane label="模型训练" name="second">
        <div class="content">
          <el-steps :space="500" :active="active" finish-status="success" align-center>
            <el-step title="选择数据集"></el-step>
            <el-step title="选择模型"></el-step>
            <el-step title="训练结果"></el-step>
          </el-steps>
          <div v-if="active=='0'">
            <el-table
                    :data="dataSetTrain"
                    stripe
                    @selection-change="handleSelectionChange"
                    style="width: 100%">
              <el-table-column type="selection"
                               fixed="left"
                               min-width="34%">
              </el-table-column>
              <el-table-column
                      prop="name"
                      label="数据集名称"
                      min-width="33%">
              </el-table-column>
              <el-table-column
                      prop="type"
                      label="数据集类型"
                      min-width="33%">
              </el-table-column>
            </el-table>
          </div>
          <div v-if="active=='1'">
            <el-form :model="Aform" label-width="700px">
              <el-form-item label="训练模型">
                <el-select v-model="Aform.name" placeholder="请选择训练模型" :key="model">
                  <el-option
                          v-for="item in modelList"
                          :key="item.name"
                          :label="item.name"
                          :value="item.name">
                  </el-option>
                </el-select>
                <el-button @click="dialogVisible = true">新建模型</el-button>
              </el-form-item>
              <el-form-item label="训练次数">
                <el-select v-model="Aform.counts" placeholder="请选择训练次数">
                  <el-option label="500" value="500"></el-option>
                  <el-option label="1000" value="1000"></el-option>
                </el-select>
              </el-form-item>
            </el-form>
          </div>
          <div v-if="active=='2'">
            <el-table size="small" current-row-key="id" :data="dataList" stripe style="width: 100%"
                      max-height="700"
                      highlight-current-row>

              <el-table-column v-for="i in datawidth"
                               :prop="i.toString()" :label="i.toString()" align="center">

              </el-table-column>
            </el-table>
          </div>
          <el-button @click="next" style="float: right">下一步</el-button>
          <el-button v-if="active=='0'" @click="dialogDataSetVisible = true" style="float: right;margin-right: 10px">上传新数据集</el-button>
          <el-button @click="back">上一步</el-button>
        </div>
      </el-tab-pane>
      <el-tab-pane label="模型预测" name="third">模型预测</el-tab-pane>
      <el-tab-pane label="模型管理" name="fourth">定时任务补偿</el-tab-pane>
    </el-tabs>
    <el-dialog
            title="新建模型"
            :visible.sync="dialogVisible"
            width="30%">
      <el-form :model="model" label-width="80px">
        <el-form-item label="模型名">
          <el-input v-model="model.name"></el-input>
        </el-form-item>
        <el-form-item label="模型类型">
          <el-select v-model="model.type" placeholder="请选择模型类型">
            <el-option label="SVM" value="SVM"></el-option>
            <el-option label="KNN" value="KNN"></el-option>
          </el-select>
        </el-form-item>
      </el-form>
    <el-button type="primary" @click="SubmitModel">确 定</el-button>
  </span>
    </el-dialog>
    <el-dialog title="上传模型" :visible.sync="dialogDataSetVisible">
      <el-form>
        <el-form-item label="数据集">
          <el-upload
                  action="http://localhost:8080/new_addfilejson.action" :limit="1"
                  :on-preview="handlePreview"
                  :on-success="handsuccess"
                  :data={username:nowuser,type:datasetType}
          ><el-button
                  size="small" type="primary">点击上传</el-button> </el-upload>
        </el-form-item>
        <el-form-item label="数据集类型">
          <el-select v-model="datasetType" placeholder="请选择">
            <el-option
                  v-for="item in datasetTypeOptions" :label="item.type" :value="item.type">
            </el-option>
          </el-select>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="uploadnewdataset">取消</el-button>
        <el-button type="primary" @click="uploadnewdataset">确定</el-button>
      </div>
    </el-dialog>

  </div>
</div>
</body>
<script>
  var vue = new Vue({
    el: '#app',
    data: {
      nowuser:'123',//测试用
      datawidth:0,
      restext:'',
      options:['KNN算法','SVM算法'],
      dataList: [],
      formData: {'csv':'','type':'KNN算法'},// 表单数据
      loginData: {},// 表单数据
      registData: {},// 表单数据
      dialogFormVisible: false,
      LoginFormVisible: false,
      registFormVisible: false,
      activeName:'first',
      dataSetTable:[{
        name:'example1.csv',
        type:'训练集'
      },{
        name:'example2.csv',
        type:'训练集'
      },{
        name:'example3.csv',
        type:'测试集'
      }],
      dataSetTrain:[{
        name:'example1.csv',
        type:'训练集'
      },{
        name:'example2.csv',
        type:'训练集'
      }],
      active:0,
      checkDatasets:[],
      Aform:{
        name:'',
        counts:''
      },
      datasetType:'训练集',
      datasetTypeOptions:[
        {
          type:'训练集'
        },
        {
          type:'测试集'
        }
      ],
      dialogDataSetVisible:false,
      modelList:[{
        id:'',
        name:'模型1',
        type:'SVM',
        owner:''
      },{
        id:'',
        name:'模型2',
        owner:'',
        type:'KNN'
      },],
      model:{
        name:'',
        type:'',
        owner:'123'
      },
      dialogVisible:false,
      dataSetloading:false,
    },
    created() {
      let _this = this;
      var nowuser = sessionStorage.getItem("nowuser");
      if(nowuser && nowuser != 'null'){
        _this.nowuser = nowuser;
      }
      this.getModelList()
      this.getDataSetList()
    },
    methods: {
      uploadnewdataset(){
        this.dialogDataSetVisible=false
        this.getDataSetList()
      },
      handlePreview(file) {
        console.log(file);
      },
      getModelList(){

        var param={
          owner:this.nowuser
        }
        axios.post("http://localhost:8080/getmodel.action",param)
                .then(res => {
                  this.modelList=res.data
                })
      },
      getDataSetList() {
        this.dataSetloading=true
        var param={
          owner:this.nowuser
        }
        axios.post("http://localhost:8080/getdataset.action",param)
                .then(res => {
                  this.dataSetTable=res.data
                })
        this.dataSetloading=false
      },
      SubmitModel(){
        axios.post("http://localhost:8080/newModel.action",this.model)
                .then(() => {
                  this.$message({
                    type: 'success',
                    message: '新建成功!'
                  });
                  this.getModelList()
                })
                .catch(err => {
                  alert("新建失败");
                })
        this.dialogVisible=false
      },
      handsuccess(response, file, fileList) {
        this.formData.csv = response;
      },
      handleRegistAct(){
        let _this = this;

        axios.post("http://localhost:8080/registactjson.action", _this.registData)
                .then(res => {
                  console.log(res.data);
                  var obj = res.data;

                  var message = obj['message'];

                  alert(message);

                  if(message == "注册成功，请登录"){
                    _this.registFormVisible = false;
                  }

                })
                .catch(err => {
                  console.log(err)
                  alert("注册失败");
                })
      },
      handleLoginAct() {

        let _this = this;

        axios.post("http://localhost:8080/loginactjson.action", _this.loginData)
                .then(res => {
                  console.log(res.data);
                  var obj = res.data;

                  var message = obj['message'];

                  alert(message);

                  if(message == "登录成功"){
                    _this.LoginFormVisible = false;

                    _this.nowuser = obj['mingzi'];
                    sessionStorage.setItem('nowuser',_this.nowuser);
                  }

                })
                .catch(err => {
                  console.log(err)
                  alert("登录失败");
                })
      },
      // 添加
      handleAdd() {

        let _this = this;

        if(_this.nowuser == '' || _this.nowuser == 'null'){
          this.$message('请先登录');
          return;
        }

        axios.post("http://localhost:8080/fenxiactjson.action", _this.formData)
                .then(res => {
                  console.log(res.data);
                  var obj = res.data;
                  alert("分析成功");
                  _this.dialogFormVisible = false;

                  _this.restext = obj['type'] + ",总数据为：" + obj['zongshu'] + "条," + "分析正确 " + obj['zhengqueshu'] + "条,";

                  var jieguo = obj['jieguo'];

                  _this.restext += "clean项：" + jieguo['clean'] + "条,";
                  _this.restext += "buggy项：" + jieguo['buggy'] + "条";

                  for(var i = 0;i < obj['result'].length;i++){

                    var resitem = obj['result'][i];

                    var dataitem = {};
                    for(var j = 0;j < resitem.length;j++){
                      dataitem[j] = resitem[j];
                    }

                    _this.datawidth = obj['result'][0].length - 1;

                    _this.dataList.push(dataitem);
                  }

                  console.log(_this.dataList);


                })
                .catch(err => {
                  console.log(err)
                  alert("分析失败");
                })
      },
      // 重置表单
      resetForm(type) {
      },
      // 弹出添加窗口
      handleCreate() {
        this.dialogFormVisible = true;
      },
      handleLogin() {
        window.location = "login.html";
      },
      handleRegist() {
        window.location = "regist.html";
      },
      zhuxiao() {
        this.nowuser = '';
        sessionStorage.clear();
      },
      next() {
        if(this.active++>2) this.active=0
        console.log(this.active)
      },
      back() {
        if(this.active==0)
        {
          return
        }
        this.active--
      },
      handleSelectionChange(val) {
        checkDatasets = val
      },
    }
  })
</script>
</html>